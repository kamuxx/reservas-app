<p-dialog [(visible)]="visible" [modal]="true" [style]="{width: '90%', maxWidth: '600px'}"
    [contentStyle]="{'background-color': '#ffffff'}" [header]="isEditing ? 'Editar Reserva' : 'Detalles de la Reserva'"
    (onHide)="close()" [resizable]="false" [draggable]="false" styleClass="rounded-xl overflow-hidden bg-white">

    <ng-container *ngIf="loading">
        <div class="flex justify-center py-10">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
        </div>
    </ng-container>

    <ng-container *ngIf="!loading && reservation">

        <!-- View Mode -->
        <div *ngIf="!isEditing" class="flex flex-col gap-6">

            <!-- Header Info -->
            <div class="flex flex-col gap-2">
                <div class="relative h-48 rounded-xl overflow-hidden shadow-sm">
                    <img [src]="reservation.space?.images?.[0] || 'https://primefaces.org/cdn/primeng/images/card-ng.jpg'"
                        class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div class="absolute bottom-4 left-4 text-white">
                        <h3 class="text-2xl font-bold leading-none">{{ reservation.event_name || 'Evento sin nombre' }}
                        </h3>
                        <p class="text-white/90 text-sm mt-1">{{ reservation.space?.name }}</p>
                    </div>
                </div>

                <div class="flex justify-between items-center mt-2">
                    <div class="flex flex-col">
                        <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Estado</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span
                                class="px-3 py-1 rounded-full text-xs font-bold text-white shadow-sm flex items-center gap-1.5"
                                [ngClass]="getStatusColor(reservation.status?.name)">
                                <span class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                                {{ reservation.status?.name }}
                            </span>
                        </div>
                    </div>
                    <div class="flex flex-col items-end">
                        <span class="text-xs text-slate-500 uppercase font-bold tracking-wider">Total</span>
                        <span class="text-xl font-bold text-emerald-600">{{ reservation.event_price | currency:'USD'
                            }}</span>
                    </div>
                </div>
            </div>

            <!-- Details Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50 p-5 rounded-xl border border-slate-100">
                <div class="flex items-start gap-3">
                    <i class="pi pi-calendar text-emerald-500 text-xl mt-1"></i>
                    <div>
                        <span class="text-xs uppercase font-bold text-slate-400 block mb-0.5">Fecha</span>
                        <span class="text-sm font-semibold text-slate-700">{{ reservation.event_date }}</span>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <i class="pi pi-clock text-emerald-500 text-xl mt-1"></i>
                    <div>
                        <span class="text-xs uppercase font-bold text-slate-400 block mb-0.5">Horario</span>
                        <span class="text-base font-semibold text-slate-700">
                            {{ formatTime(reservation.start_time) }} - {{ formatTime(reservation.end_time) }}
                        </span>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <i class="pi pi-users text-emerald-500 text-xl mt-1"></i>
                    <div>
                        <span class="text-xs uppercase font-bold text-slate-400 block mb-0.5">Asistentes</span>
                        <span class="text-sm font-semibold text-slate-700">{{ reservation.space?.capacity }} Personas
                            (Máx)</span>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <i class="pi pi-map-marker text-emerald-500 text-xl mt-1"></i>
                    <div>
                        <span class="text-xs uppercase font-bold text-slate-400 block mb-0.5">Ubicación</span>
                        <span class="text-sm font-semibold text-slate-700">San Cristóbal, Táchira</span>
                    </div>
                </div>
            </div>

            <!-- Amenities Section -->
            <div>
                <h4 class="text-sm font-bold text-slate-800 mb-3 flex items-center gap-2">
                    <i class="pi pi-sparkles text-emerald-500"></i>
                    Amenidades Incluidas
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <div class="flex items-center gap-2 text-slate-700 text-xs font-medium">
                        <div
                            class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0">
                                </path>
                            </svg>
                        </div>
                        <span>WiFi</span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-700 text-xs font-medium">
                        <div
                            class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                </path>
                            </svg>
                        </div>
                        <span>Proyector</span>
                    </div>
                    <div class="flex items-center gap-2 text-slate-700 text-xs font-medium">
                        <div
                            class="w-8 h-8 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                </path>
                            </svg>
                        </div>
                        <span>Café</span>
                    </div>
                </div>
            </div>

            <div *ngIf="reservation.event_description" class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                <h4 class="text-xs font-bold text-blue-800 mb-1 uppercase tracking-wide">Notas del Evento</h4>
                <p class="text-sm text-blue-900 leading-relaxed">{{ reservation.event_description }}</p>
            </div>

            <!-- Actions -->
            <div *ngIf="!canEdit(reservation) && !isPastReservation && reservation.status?.name !== 'Cancelada'"
                class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-3">
                <i class="pi pi-info-circle text-amber-500 mt-0.5"></i>
                <div class="text-xs text-amber-800">
                    <span class="font-bold block mb-1">Modificación cerrada</span>
                    Las opciones de editar o cancelar solo están disponibles hasta 1 hora antes del evento.
                </div>
            </div>

            <!-- Review Section (Past Events) -->
            <div *ngIf="isPastReservation"
                class="bg-slate-50 p-5 rounded-xl border border-slate-100 mt-4 animate-fade-in-up">
                <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="pi pi-star text-yellow-500"></i>
                    Califica tu experiencia
                </h3>

                <div class="mb-5">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Puntuación</label>
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <p-slider [(ngModel)]="reviewForm.rating" [min]="1" [max]="5" [step]="1"></p-slider>
                        </div>
                        <span class="font-bold text-xl text-emerald-600 w-8 text-center">{{reviewForm.rating}}</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 mt-1 px-1">
                        <span>1</span><span>2</span><span>3</span><span>4</span><span>5</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Comentario</label>
                    <textarea rows="3" pInputTextarea [(ngModel)]="reviewForm.comment"
                        class="w-full text-sm p-3 border-slate-200 rounded-lg focus:border-emerald-500 focus:ring-emerald-500 bg-white! text-slate-900!"
                        placeholder="Cuéntanos qué te pareció el espacio..."></textarea>
                </div>

                <div class="flex justify-end">
                    <button pButton label="Enviar Reseña" icon="pi pi-send"
                        class="p-button-sm bg-emerald-600 border-none hover:bg-emerald-700 font-bold px-4"
                        (click)="saveReview()">
                    </button>
                </div>
            </div>

            <div class="flex gap-3 mt-4 pt-4 border-t border-slate-100" *ngIf="canEdit(reservation)">
                <button pButton label="Cancelar Reserva" icon="pi pi-times"
                    class="p-button-danger p-button-outlined flex-1" (click)="confirmCancellation()">
                </button>
                <button pButton label="Modificar" icon="pi pi-pencil"
                    class="p-button-primary flex-1 bg-emerald-600 border-emerald-600 hover:bg-emerald-700"
                    (click)="startEdit()">
                </button>
            </div>
        </div>

        <!-- Edit Mode (Future Only) -->
        <div *ngIf="isEditing" class="flex flex-col gap-4">

            <!-- Calendar View -->
            <div class="bg-white border border-slate-200 rounded-xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex gap-1">
                        <button class="p-1 hover:bg-slate-100 rounded" mwlCalendarPreviousView [view]="view"
                            [(viewDate)]="viewDate" (viewDateChange)="closeOpenMonthViewDay()">
                            <i class="pi pi-chevron-left text-sm"></i>
                        </button>
                        <button class="px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 rounded font-medium"
                            mwlCalendarToday [(viewDate)]="viewDate">Hoy</button>
                        <button class="p-1 hover:bg-slate-100 rounded" mwlCalendarNextView [view]="view"
                            [(viewDate)]="viewDate" (viewDateChange)="closeOpenMonthViewDay()">
                            <i class="pi pi-chevron-right text-sm"></i>
                        </button>
                    </div>
                    <span class="text-sm font-bold text-slate-800 capitalize">{{ viewDate | date:'MMMM yyyy' }}</span>
                </div>

                <mwl-calendar-month-view [viewDate]="viewDate" [events]="events" [refresh]="refresh"
                    [activeDayIsOpen]="activeDayIsOpen" (dayClicked)="dayClicked($event.day)">
                </mwl-calendar-month-view>
            </div>

            <!-- Time Slots Selection -->
            <div *ngIf="startDate" class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3 flex justify-between items-center">
                    Horarios Disponibles
                    <span
                        class="normal-case font-normal bg-white px-2 py-0.5 rounded border border-slate-200 text-slate-600">{{selectedDateStr}}</span>
                </h4>

                <div class="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-1">
                    <div *ngFor="let time of timeOptions" [ngClass]="getSlotClasses(time)" (click)="selectTime(time)"
                        class="px-2 py-2 rounded text-xs text-center border transition-all select-none">
                        {{time}}
                    </div>
                </div>
                <div class="mt-2 text-center text-xs text-slate-400" *ngIf="!editForm.start_time">
                    Selecciona hora de inicio y fin
                </div>
                <div class="mt-2 text-center font-bold text-emerald-600 text-sm"
                    *ngIf="editForm.start_time && editForm.end_time">
                    {{editForm.start_time}} - {{editForm.end_time}}
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-slate-700">Nombre del Evento</label>
                <input type="text" pInputText [(ngModel)]="editForm.event_name" class="w-full">
            </div>

            <div class="flex gap-3 mt-4 justify-end">
                <button pButton label="Cancelar" class="p-button-text text-slate-500" (click)="cancelEdit()"></button>
                <button pButton label="Guardar Cambios" class="bg-emerald-600 border-none hover:bg-emerald-700"
                    [disabled]="!editForm.start_time || !editForm.end_time" (click)="saveReservation()">
                </button>
            </div>
        </div>

    </ng-container>
</p-dialog>

<p-confirmDialog [style]="{width: '90%', maxWidth: '400px'}"></p-confirmDialog>
<p-toast></p-toast>